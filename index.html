<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Three.js Testing</title>
        <link rel="stylesheet" href="style.css">
	</head>
	<body>
        <div id="filecontainer">
            <input type="file" onchange="openFiles()" id="fileExplorer" multiple>
        </div>

		<script src="js/three.js"></script>
		<script>
            let imageIndex = 0;
            var loadedImages = []
            var loadedMats = []
            var panoMat
            function openFiles(){
                var images = document.getElementById('fileExplorer').files;
                document.getElementById('fileExplorer').style.display = "none";
                function readFile(index){
                    var reader = new FileReader();
                    if(index >= images.length-1){return;}

                    var file = images[index];

                    reader.onload = function(e){
                        //loadedImages.push(e.target.result);
                        loadedMats.push(new THREE.MeshBasicMaterial( { color: 0xffffff, map: THREE.ImageUtils.loadTexture(e.target.result), side: THREE.DoubleSide} ));
                        readFile(index+1);
                    }
                    reader.readAsDataURL(images[index]);
                }
                readFile(0);
                main();
            }
            function main(){
                document.addEventListener('keydown', keyPressed);
                var mouseBool = false;
                var oldMouseX;
                var oldMouseY;

                window.onresize = resizeWindow;

                function resizeWindow(){
                    renderer.setSize( window.innerWidth, window.innerHeight );
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                }

                function keyPressed(e) {
                    if(`${e.code}` == "KeyA"){
                        if(imageIndex > 0){
                            imageIndex--;
                        }
                    panosphere.material = loadedMats[imageIndex];
                    }
                    if(`${e.code}` == "KeyD"){
                        if(imageIndex < loadedMats.length-1){
                            imageIndex++;
                        }
                        panosphere.material = loadedMats[imageIndex];
                    }
                }

                function mouseMoved(e){
                    var mouseX, mouseY;
                    if(e.offsetX) {
                        mouseX = e.offsetX;
                        mouseY = e.offsetY;
                    }
                    else if(e.layerX) {
                        mouseX = e.layerX;
                        mouseY = e.layerY;
                    }
                    if(mouseBool && oldMouseX && mouseX && oldMouseY && mouseY){

                        panosphere.rotation.y += (oldMouseX-mouseX)/360;
                        panosphere.rotation.x += (oldMouseY-mouseY)/360;

                        
                        oldMouseX = mouseX
                        oldMouseY = mouseY
                    }

                    if(panosphere.rotation.y > 360){
                        panosphere.rotation.y = panosphere.rotation.y - 360;
                    }

                    if(panosphere.rotation.x > Math.PI/2){
                        panosphere.rotation.x = Math.PI/2;
                    }
                    if(panosphere.rotation.x < -(Math.PI/2)){
                        panosphere.rotation.x = -(Math.PI/2);
                    }
                }

                function mouseDown(e){
                    if(e.offsetX) {
                        mouseX = e.offsetX;
                        mouseY = e.offsetY;
                    }
                    else if(e.layerX) {
                        mouseX = e.layerX;
                        mouseY = e.layerY;
                    }

                    mouseBool = true;
                    oldMouseX = mouseX
                    oldMouseY = mouseY
                }

                function mouseUp(e){
                    mouseBool = false;
                }

                var scene = new THREE.Scene();
                var camera = new THREE.PerspectiveCamera( 90, window.innerWidth / window.innerHeight, 0.1, 1000 );
                var renderer = new THREE.WebGLRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );

                renderer.domElement.addEventListener('mousemove', mouseMoved);
                renderer.domElement.addEventListener('mousedown', mouseDown);
                renderer.domElement.addEventListener('mouseup', mouseUp);

                var sphere = new THREE.SphereBufferGeometry(1, 64, 32);
                panoMat = loadedMats[0];

                var panosphere = new THREE.Mesh(sphere, panoMat);
                scene.add( panosphere );

                camera.position.z = 0;

                function animate() {
                    //panosphere.rotation.y += 0.01;
                    requestAnimationFrame( animate );
                    renderer.render( scene, camera );
                }
                animate();
            } 
		</script>
	</body>
</html>